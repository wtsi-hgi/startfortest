language: python

python:
  - 3.6

env:
  matrix:
    - TEST_LATEST_ONLY=0
    - TEST_LATEST_ONLY=1

services:
  - docker

before_install:
  - sudo apt-get update && sudo apt-get --only-upgrade install docker-ce
  - pip install codecov

install:
  - pip install -r test_requirements.txt
  - pip install -r requirements.txt
  - printf "ubuntu:.*\ndebian:.*\nalpine:.*\npython:.*" > no-gc-images.txt
  - docker run -d -v /var/run/docker.sock:/var/run/docker.sock:ro -v $PWD:/working -e EXCLUDE_FROM_GC=/working/no-gc-images.txt spotify/docker-gc watch -n 300 /docker-gc
  - docker run --privileged -d -v /var/run/docker.sock:/var/run/docker.sock:ro docker watch -n 300 docker system prune -f

script:
  - PYTHONPATH=. coverage run -m unittest discover -v -s useintest/tests
  - coverage run setup.py install
  - coverage combine -a
  - coverage report

after_success:
  - codecov
